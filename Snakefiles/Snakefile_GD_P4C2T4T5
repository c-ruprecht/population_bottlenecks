import os
from snakemake.io import expand, directory
import re
# First, add this import at the top of your file
import glob


# PATHS
INPUT_DIR = '/sc/arion/work/ruprec02/population-bottlenecks/experiments/P4C2T4T5/FP/'
OUTPUT_DIR = '/sc/arion/work/ruprec02/population-bottlenecks/experiments/P4C2T4T5/' 

# Create main output directory structure
os.makedirs(OUTPUT_DIR + "GD", exist_ok=True)


SAMPLE_NAMES = {'ST1': '/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C2T4T5/24h_stool_gdmeta.csv',
                'ST4':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C2T4T5/24h_stool_gdmeta.csv',
                'ST5':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C2T4T5/24h_stool_gdmeta.csv',
                'ST6':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C2T4T5/24h_stool_gdmeta.csv',
                }


rule all:
    input:
        expand(OUTPUT_DIR + "GD/{strain}/GD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/CorrectedRD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/CorrectedFRD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        

rule get_GD:
    input:
        freq = INPUT_DIR + "/{strain}/FrequenciesWithoutNoise.csv"
    output:
        corrected_rd = OUTPUT_DIR + "GD/{strain}/CorrectedRD_{strain}.csv",
        gd = OUTPUT_DIR + "GD/{strain}/GD_{strain}.csv",
        corrected_frd = OUTPUT_DIR + "GD/{strain}/CorrectedFRD_{strain}.csv"
    params:
        output_dir = OUTPUT_DIR + "GD/{strain}/",
        scripts_dir = '/hpc/users/ruprec02/git/population_bottlenecks/scripts',
        metadata = lambda wildcards: SAMPLE_NAMES[wildcards.strain],
        expname = "{strain}",
        limit = 1000#10000
    log:
        OUTPUT_DIR + "GD/{strain}/GD_complete.log"
    shell:
        """
        mkdir -p {params.output_dir}
        mkdir -p $(dirname {log})
        ml R/4.2.0
        Rscript {params.scripts_dir}/MajorityDistance_12112023_wrapper.R \
            {input.freq} \
            {params.expname} \
            {params.metadata} \
            {params.limit} \
            {params.output_dir} &> {log}
        """