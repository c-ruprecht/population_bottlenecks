import os
from snakemake.io import expand, directory
import re
# First, add this import at the top of your file
import glob


# PATHS
INPUT_DIR = '/sc/arion/work/ruprec02/population-bottlenecks/experiments/P4C1T8/c1gavageFP'
OUTPUT_DIR = '/sc/arion/work/ruprec02/population-bottlenecks/experiments/P4C1T8/' 

# Create main output directory structure
os.makedirs(OUTPUT_DIR + "GD", exist_ok=True)


SAMPLE_NAMES = {'c2_ST1': '/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C1T8/cage2_stool_gdmeta.csv',
                'c2_ST5':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C1T8/cage2_stool_gdmeta.csv',
                'c5_ST1':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C1T8/cage5_stool_gdmeta.csv',
                'c5_ST4':'/hpc/users/ruprec02/git/population_bottlenecks/input_files/gd_sheets/P4C1T8/cage5_stool_gdmeta.csv',
                }


rule all:
    input:
        expand(OUTPUT_DIR + "GD/{strain}/GD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/CorrectedRD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/CorrectedFRD_{strain}.csv", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/heatmaps/GD_{strain}_heatmap_GD.png", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/heatmaps/CorrectedFRD_{strain}_heatmap_corrRD.png", strain=SAMPLE_NAMES.keys()),
        expand(OUTPUT_DIR + "GD/{strain}/heatmaps/CorrectedRD_{strain}_heatmap_corrFRD.png", strain=SAMPLE_NAMES.keys())

rule get_GD:
    input:
        freq = INPUT_DIR + "/{strain}/FrequenciesWithoutNoise.csv"
    output:
        corrected_rd = OUTPUT_DIR + "GD/{strain}/CorrectedRD_{strain}.csv",
        gd = OUTPUT_DIR + "GD/{strain}/GD_{strain}.csv",
        corrected_frd = OUTPUT_DIR + "GD/{strain}/CorrectedFRD_{strain}.csv"
    params:
        output_dir = OUTPUT_DIR + "GD/{strain}/",
        scripts_dir = '/hpc/users/ruprec02/git/population_bottlenecks/scripts',
        metadata = lambda wildcards: SAMPLE_NAMES[wildcards.strain],
        expname = "{strain}",
        limit = 10000
    log:
        OUTPUT_DIR + "GD/{strain}/GD_complete.log"
    shell:
        """
        mkdir -p {params.output_dir}
        mkdir -p $(dirname {log})
        ml R/4.2.0
        Rscript {params.scripts_dir}/MajorityDistance_12112023_wrapper.R \
            {input.freq} \
            {params.expname} \
            {params.metadata} \
            {params.limit} \
            {params.output_dir} &> {log}
        """


rule create_heatmaps:
    input:
        gd = OUTPUT_DIR + "GD/{strain}/GD_{strain}.csv",
        corrected_rd = OUTPUT_DIR + "GD/{strain}/CorrectedRD_{strain}.csv",
        corrected_frd = OUTPUT_DIR + "GD/{strain}/CorrectedFRD_{strain}.csv"
    output:
        gd_heatmap = OUTPUT_DIR + "GD/{strain}/heatmaps/GD_{strain}_heatmap_GD.png",
        corrected_rd_heatmap = OUTPUT_DIR + "GD/{strain}/heatmaps/CorrectedRD_{strain}_heatmap_corrRD.png",
        corrected_frd_heatmap = OUTPUT_DIR + "GD/{strain}/heatmaps/CorrectedFRD_{strain}_heatmap_corrFRD.png"
    params:
        input_dir = OUTPUT_DIR + "GD/{strain}/",
        output_dir = OUTPUT_DIR + "GD/{strain}/heatmaps/",
        scripts_dir = '/hpc/users/ruprec02/git/population_bottlenecks/scripts'
    log:
        OUTPUT_DIR + "GD/{strain}/heatmaps/create_heatmaps.log"
    shell:
        """
        mkdir -p {params.output_dir}
        ml anaconda3
        python {params.scripts_dir}/create_heatmaps.py \
            -i {params.input_dir} \
            -o {params.output_dir} &> {log}
        """

