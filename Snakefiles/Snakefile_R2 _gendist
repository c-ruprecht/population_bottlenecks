import os
from snakemake.io import expand, directory
import re
# First, add this import at the top of your file
import glob


# PATHS
OUTPUT_DIR = '/sc/arion/work/ruprec01/results/P4C2-run1-R2/'  


# Create main output directory structure
os.makedirs(OUTPUT_DIR + "4-moleculetables", exist_ok=True)


STRAINS="ST1,ST2,ST4,ST5,ST6"
SAMPLE_NAMES = STRAINS.split(",")

rule all:
    input:
        OUTPUT_DIR + "4-moleculetables/molecule_table.done",
        expand(OUTPUT_DIR + "5-FP/{strain}/{strain}.FP_complete.done", strain=SAMPLE_NAMES),
        

rule get_FP:
    input:
        OUTPUT_DIR + "4-moleculetables/{strain}_readstable.csv"
    output:
        OUTPUT_DIR + "5-FP/{strain}/{strain}.FP_complete.done"
    params:
        output_dir=directory(OUTPUT_DIR + "5-FP/{strain}/"),
    log:
        OUTPUT_DIR + "0-logs/FP/{strain}_FP_complete.log"
    shell:
        """
        mkdir -p {params.output_dir}
        mkdir -p $(dirname {log})
        ml R/4.2.0
        # Process single file with error handling
        echo "Processing {input} using getFP.R"
        if Rscript scripts/getFP_3.R {input} NULL "1" 0.03 {params.output_dir}; then
            echo "Successfully processed {input}" 
        else
            echo "WARNING: Error processing {input}, creating empty output file"
            touch {params.output_dir}/empty_output  # Create a file inside the directory
        fi &> {log}
        
        # Always touch the done file so the workflow can continue
        touch {output}
        """

